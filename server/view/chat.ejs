<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Demo for Video-Conf App</title>

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

</head>
<body>
<div class="container">
  <div class="row">
  <h2>Chat Window</h2>

  <div id="content"></div>
  <p>Welcome, <%= user %></p>
  </div>

  <div class="row" style="height:70%;">
    <div class="col-sm-2 cold-md-2 col-lg-2">
      <div class="panel panel-default">
        <div class="panel-heading">Online users</div>
        <center id="usersList">
          <!--div class="panel-body" style="padding:5px;">Bobi</div>
          <div class="panel-body" style="padding:5px;">joaoo</div>
          <div class="panel-body" style="padding:5px;">maria</div>
          <div class="panel-body" style="padding:5px;">tareco</div-->
        </center>
      </div>
    </div>

    <div class="col-sm-10 cold-md-10 col-lg-10">
      <textarea id="chatarea" readonly="readonly" style="width:100%;height:100%; box-sizing: border-box; -moz-box-sizing: border-box"></textarea>
    </div>
  </div>
<br/>

  <div class="row" style="height:10%;">
    <div class="col-sm-2 cold-md-2 col-lg-2">
      <button type="submit" class="btn btn-primary">Video Chat</button>
    </div>

    <div class="col-sm-10 cold-md-10 col-lg-10">
      <input id="chatinput" placeholder="Write something.."
        style="width:100%;height:100%; box-sizing: border-box; -moz-box-sizing: border-box">
    </div>
    </div>
  </div>
</div>




  <!-- build:production -->
  <script src="jspm_packages/system.js"></script>
  <script src="config.js"></script>

  <script>
    //System.import('index');

   if (false && location.origin.match(/localhost/))
   {
      System.trace = true;
      System.import('capaj/systemjs-hot-reloader').then(function(HotReloader) {
        new HotReloader.default('http://localhost:3000');
      });
    }

  </script>

  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

  <!---script src="jquery.timer.js" type="text/javascript"></script-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.8/socket.io.js" type="text/javascript" ></script>

  <script>

  function print(s,s1) { console.log(s); if (s1) console.log(s1); }

  function addUser(user) {
    print('Add User', user);
    $('#usersList').append('<div class="panel-body" id="user_' + user.name
              + '" style="padding:5px;">'+user.name +'</div>');
  }

  $(function(){

    var socket = io.connect('localhost:4000');

    socket.on('users', function (users) {
      print('Received user list len ' + users.length, users);
      users.forEach(function(u) { addUser(u); });
    });

    // Protocol

    // When a new user arrive
    socket.on('addUser', function (user) {
      addUser(user);
    });

    // When a user left
    socket.on('remUser', function (user) {
      print('Rem User: ' + user.name, user);
      $('#user_' + user.name).remove();
    });

    // When a user send a new message
    socket.on('messages', function (data) {
      print('new messages ' + data.length, data);
      data.forEach(function(d) {
        var date = new Date(d.time).toString().replace(/ GMT.*/, '');
        var str = '[' + date + '] ' + d.name + ': ' + d.msg +'\n';
        print("ADD " + str);
        $('#chatarea').append(str);
      });
    });

    // Server sent an error
    socket.on('errorr', function (msg) {
      alert('ERROR!', msg);
      socket.close();
      window.location.href = '/';
    });


    var username = '<%= user %>';

    print("Send User: " + username);
    socket.emit('user', username);

    // When I start writing
    var isTypping = 0;
    var typpingTimer;


    $("#chatinput").keypress(function(e) {
      // On enter send new message
      if(e.keyCode == 13) {
        var text = $('#chatinput').val();
        $('#chatinput').val('');
        print('send: ' + text);
        socket.emit('message', {user: username, msg: text});
      }
    });


  });

  </script>


  <!-- endbuild -->
  </div>
</body>
</html>
